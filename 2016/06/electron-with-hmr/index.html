<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>在 Electron 中使用模块热替换 · XWARTZ</title><meta name="description" content="在 Electron 中使用模块热替换 - xwartz"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/blog/favicon.ico"><link rel="stylesheet" href="//at.alicdn.com/t/font_1472710214_6648843.css"><link rel="stylesheet" href="//raw.githack.com/xwartz/hexo-theme-nuna/next/source/style/main.css?v=1.0.3"></head><body class="pupa"><div class="loading-bar"></div><main><div class="post post"><article itemscope itemtype="http://schema.org/Article" class="hentry"><div class="container"><div class="entry-header"><h1 class="entry-title">在 Electron 中使用模块热替换</h1><div class="entry-description"><p>热模块替换大行其道，开发 <code>Electron</code> 应用也是要用用才好。</p></div><div class="entry-meta"><time itemprop="datePublished" datetime="Monday, June 6th 2016, 11:45:22 am" class="updated">Jun 6, 2016</time><em class="post-count">1,897 words</em></div></div><div itemprop="articleBody" class="entry-content"><img src="/blog/2016/06/electron-with-hmr/erb.png" alt="erb.png" title="">
<p><code>Electron</code> + <code>React</code> + <code>Webpack</code> 这个组合开发桌面应用还是挺爽的。</p>
<p>如果再搭上 <code>Webpack</code> 的 <a href="http://webpack.github.io/docs/hot-module-replacement.html">Hot Module Replacement</a> 那简直完美，不用刷新就搞定。</p>
<p>关于 <code>HMR</code> 的演示可以看 Dan Abramov 的演讲视频 <a href="https://www.youtube.com/watch?v=xsSnOQynTHs">Hot Reloading with Time Travel</a>。</p>
<p>在 <code>Electron</code> 中使用 <code>HMR</code> 碰到的问题是打开的文件是本地的，<code>host</code> 就变成了 <code>file://</code>，</p>
<p>所以监听到变化之后，<code>Webpack</code> 尝试更新模块时，就查找不到 <code>hot-update.json</code> ，然后 <code>Webpack</code> 无法更新模块…</p>
<img src="/blog/2016/06/electron-with-hmr/hmr-error.png" alt="hmr-error.png" title="">
<p>当时这个问题搞疯了我，花了很长时间，所以这篇就是为了记录下当时的坑。</p>
<p>上图出现的情况，当时用的配置就是使用的比较官方的方式, 使用 <code>webpack-dev-server</code> 和 <code>react-hot-loader</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span></div><div class="line"><span class="keyword">import</span> webpack <span class="keyword">from</span> <span class="string">'webpack'</span></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">devtool</span>: <span class="string">'eval'</span>,</div><div class="line">  <span class="attr">entry</span>: [</div><div class="line">    <span class="string">'webpack-dev-server/client?http://localhost:3000'</span>,</div><div class="line">    <span class="string">'webpack/hot/only-dev-server'</span>,</div><div class="line">    <span class="string">'./src/index'</span></div><div class="line">  ],</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">path</span>: path.join(__dirname, <span class="string">'dist'</span>),</div><div class="line">    <span class="attr">filename</span>: <span class="string">'bundle.js'</span>,</div><div class="line">    <span class="attr">publicPath</span>: <span class="string">'/static/'</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">plugins</span>: [</div><div class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin()</div><div class="line">  ],</div><div class="line">  <span class="attr">module</span>: &#123;</div><div class="line">    <span class="attr">loaders</span>: [&#123;</div><div class="line">      <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</div><div class="line">      <span class="attr">loaders</span>: [<span class="string">'react-hot'</span>, <span class="string">'babel'</span>],</div><div class="line">      <span class="attr">include</span>: path.join(__dirname, <span class="string">'src'</span>)</div><div class="line">    &#125;]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后换成 <a href="https://github.com/gaearon/react-hot-loader/pull/240">React Hot Loader 3</a> 试了一下，果然不出所料，还是没能成功。</p>
<p>原本以为问题就是出在 <code>webpack-dev-server</code> 上，所以就把精力集中在替换 <code>webpack-dev-server</code> 上了。</p>
<p>然后用 <code>express</code> + <code>webpack-dev-middleware</code> + <code>webpack-hot-middleware</code> 自己搭建服务。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">'express'</span></div><div class="line"><span class="keyword">import</span> webpack <span class="keyword">from</span> <span class="string">'webpack'</span></div><div class="line"><span class="keyword">import</span> webpackDevMiddleware <span class="keyword">from</span> <span class="string">'webpack-dev-middleware'</span></div><div class="line"><span class="keyword">import</span> webpackHotMiddleware <span class="keyword">from</span> <span class="string">'webpack-hot-middleware'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'./webpack.config.dev'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> app = express()</div><div class="line"><span class="keyword">const</span> compiler = webpack(config)</div><div class="line"><span class="keyword">const</span> PORT = <span class="number">3000</span></div><div class="line"></div><div class="line">app.use(webpackDevMiddleware(compiler, &#123;</div><div class="line">  <span class="attr">publicPath</span>: config.output.publicPath,</div><div class="line">  <span class="attr">noInfo</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">reload</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">stats</span>: &#123;</div><div class="line">    <span class="attr">colors</span>: <span class="literal">true</span></div><div class="line">  &#125;</div><div class="line">&#125;))</div><div class="line"></div><div class="line"><span class="comment">// hot</span></div><div class="line">app.use(webpackHotMiddleware(compiler))</div><div class="line"></div><div class="line">app.listen(PORT, <span class="string">'localhost'</span>, (err) =&gt; &#123;</div><div class="line">  <span class="keyword">if</span> (err) &#123;</div><div class="line">    <span class="built_in">console</span>.error(err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">`Listening at http://localhost:<span class="subst">$&#123;PORT&#125;</span>`</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>然而还是不行, 最后研究了这个仓库的<a href="https://github.com/chentsulin/electron-react-boilerplate/blob/master/webpack.config.development.js">配置</a>，<br>发现还有这样的一个配置 <code>target: &#39;electron-renderer&#39;</code>，然而官方文档上却没有说明。</p>
<p class="tip"><code>target: &#39;electron-renderer&#39;</code> 属性是在 <code>Webpack</code> <code>v1.12.15</code> 版本中加入的 <a href="https://github.com/webpack/webpack/pull/2181">make <code>electron-main</code> and <code>electron-renderer</code> targets works in 1.x</a>。</p>

<p>为了避免更多人步我后尘，就去给 <code>Webpack</code> 文档增加了说明 <a href="https://github.com/webpack/docs/wiki/configuration/_compare/135c3a8e13bc72ee5e9aede3571e1e5060188390">Compare: configuration</a>。</p>
<p>这时候热替换的问题也就解决了，这个过程还能从提交历史中看到 <a href="https://github.com/xwartz/PupaFM/commits/master/dev-server.js">PupaFM</a>。</p>
<p>But…</p>
<p>当后来有时间再回顾这个问题的时候，一直在想第一种方式应该能解决才对啊，<br>所以在第一种方式的配置上加了 <code>target: &#39;electron-renderer&#39;</code>，然而并没有什么软用…</p>
<p>最后再一次查看了一遍 <code>Webpack</code> 的文档，仔细的看了 <code>output.publicPath</code> 这个配置。</p>
<h4 id="output-publicPath"><a href="#output-publicPath" class="headerlink" title="output.publicPath"></a>output.publicPath</h4><blockquote>
<p> The <code>publicPath</code> specifies the public URL address of the output files when referenced in a browser.<br> For loaders that embed <code>&lt;script&gt;</code> or <code>&lt;link&gt;</code> tags or reference assets like images,<br> <code>publicPath</code> is used as the href or url() to the file when it’s different then their location on disk (as specified by path).<br> This can be helpful when you want to host some or all output files on a different domain or on a CDN.<br> The Webpack Dev Server also takes a hint from <code>publicPath</code> using it to determine where to serve the output files from.<br> As with path you can use the [hash] substitution for a better caching profile.</p>
</blockquote>
<p>那我是不是只要把相对路径改成绝对地址，就可以监听到文件的更新了。</p>
<p>只要这样就好了嘛 <code>publicPath: &#39;http://localhost:3000/static/&#39;</code>…</p>
<p>然后写了个 demo ，具体代码可参考 <a href="https://github.com/xwartz/electron-hot-boilerplate">Electron React Hot Boilerplate</a>。</p>
<p>果然…</p>
<p>还是需要好好阅读完文档啊，虽然 <code>Webpack</code> 的文档也略坑。</p></div><div class="entry-extra"><div class="entry-tags"><a href="/blog/tags/electron/" class="tag">electron</a><a href="/blog/tags/hmr/" class="tag">hmr</a></div></div></div></article></div></main><footer><div class="copyright container"><p>© Copyright 2015 - 2018 by <a href="http://github.com/xwartz">xwartz</a>.</p></div></footer><script async src="//cdn.bootcss.com/mathjax/2.7.0-beta.0/MathJax.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-69822347-1",'auto');
ga('set', 'appName',"XWARTZ");
ga('send','pageview');</script><script>(function () { var sid =500303098;cid =500303108;var hm = document.createElement('script');
hm.src = 'http://pingjs.qq.com/h5/stats.js';
hm.setAttribute('name', 'MTAH5'); hm.setAttribute('sid', sid); hm.setAttribute('cid', cid);
var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);
}())</script><script>var _vds = _vds || [];
window._vds = _vds;
(function(){
  ;_vds.push(['setAccountId',"90b580e047dd0007"  ]);
  (function() {
      var vds = document.createElement('script');
      vds.type='text/javascript';
      vds.async = true;
      vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(vds, s);
  })();
})();</script><script async src="//raw.githack.com/Easyfood/pageAccelerator/master/dist/page-accelerator.min.js"></script><script async src="/blog/script/loading.js"></script><script async src="/blog/script/photo.js"></script></body></html>